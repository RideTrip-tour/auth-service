# –°–µ—Ä–≤–∏—Å –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Auth Service)

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ FastAPI. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É [FastAPI Users](https://fastapi-users.github.io/fastapi-users/) –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫—É OAuth2.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
*   –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º JWT —Ç–æ–∫–µ–Ω–æ–≤ (–ª–æ–≥–∏–Ω/–≤—ã—Ö–æ–¥).
*   –°–±—Ä–æ—Å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è.
*   –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OAuth2 –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã.
*   –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ.
*   –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏).
*   –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.


## üöÄ –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/RideTrip-tour/auth-service.git
cd auth-service
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.

```bash
python -m venv venv
source venv/bin/activate  # –î–ª—è Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–≤ `.env.example` (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å), –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä `.env`:
```env
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASS=postgres
DB_NAME=auth_db

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –∫–ª—é—á!
# openssl rand -hex 32
SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –∑–∞–ø—É—â–µ–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä PostgreSQL.

```bash
alembic upgrade head
```

### 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
uvicorn main:app --reload
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://127.0.0.1:8000`.

## üìö API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (Swagger UI) –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É:

`http://127.0.0.1:8000/docs`


## –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ `app/db/models.py`:

```python
class User(AuditMixin, SQLAlchemyBaseUserTable[int], Base):
    id: Mapped[int] = mapped_column(primary_key=True)
```

- **AuditMixin** ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—è –∞—É–¥–∏—Ç–∞: `created_at`, `updated_at`, `deleted_at` –∏ –º–µ—Ç–æ–¥—ã `soft_delete()`, `restore()`.
- **SQLAlchemyBaseUserTable[int]** ‚Äî –±–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ FastAPI Users —Å –ø–æ–ª—è–º–∏ email, –ø–∞—Ä–æ–ª—å, —Ñ–ª–∞–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- **Base** ‚Äî –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –±–∞–∑–∞ SQLAlchemy.
- **id** ‚Äî —è–≤–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.
- –°–≤—è–∑—å **oauth_accounts** ‚Äî –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ OAuth-–∞–∫–∫–∞—É–Ω—Ç–æ–≤ (—Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º).

**üìã User Table:**
- `id` (PK) ‚Äî –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (int)
- `email` (UNIQUE) ‚Äî email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (320 chars)
- `hashed_password` ‚Äî —Ö—ç—à –ø–∞—Ä–æ–ª—è (1024 chars)
- `is_active` ‚Äî –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç
- `is_superuser` ‚Äî –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `is_verified` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email
- `created_at`, `updated_at`, `deleted_at` (AuditMixin) ‚Äî –∞—É–¥–∏—Ç –∏ –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

**üîó OAuthAccount Table:**
- `id` (PK) ‚Äî –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (int)
- `user_id` (FK ‚Üí user.id, ondelete=cascade) ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü
- `oauth_name` ‚Äî –ø—Ä–æ–≤–∞–π–¥–µ—Ä (google/github –∏ —Ç.–¥.)
- `access_token` ‚Äî —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞
- `expires_at` ‚Äî –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- `refresh_token` ‚Äî —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `account_id` ‚Äî ID —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `account_email` ‚Äî email —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `created_at`, `updated_at`, `deleted_at` (AuditMixin) ‚Äî –∞—É–¥–∏—Ç –∏ –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

**üìä Relations:**
- `User 1‚îÄ‚îÄ‚îÄ* OAuthAccount` (–æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –º–Ω–æ–≥–æ OAuth –∞–∫–∫–∞—É–Ω—Ç–æ–≤)
- –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ OAuth –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- Email: –≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –º–∞–∫—Å–∏–º—É–º 320 —Å–∏–º–≤–æ–ª–æ–≤, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π
- –ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- –í—Å–µ –±—É–ª–µ–≤—ã –ø–æ–ª—è –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ò–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –ø–æ–∏—Å–∫ –ø–æ email –∏ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º

---

## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (verify)

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –¥–≤–∞ —à–∞–≥–∞: –∑–∞–ø—Ä–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø–∏—Å—å–º–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –ë–î —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

### 1. –ó–∞–ø—Ä–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî `POST /register`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `email` –∏ `password` (—Å—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º email –µ—â—ë –Ω–µ—Ç. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –æ—Ç–≤–µ—Ç `400` —Å –∫–æ–¥–æ–º `REGISTER_USER_ALREADY_EXISTS`.
- –ü–∞—Ä–æ–ª—å –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞). –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî `400` —Å –∫–æ–¥–æ–º `REGISTER_INVALID_PASSWORD`.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î**. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å –¥–∞–Ω–Ω—ã—Ö (email, —Ö—ç—à –ø–∞—Ä–æ–ª—è –∏ —Ç.–¥.) –∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ö—É–∫ `on_before_register`.

**–í `on_before_register` (—Å–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π):**

- –í –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–µ `aud` (audience –¥–ª—è —Ç–æ–∫–µ–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏).
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JWT —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email, `hashed_password` –∏ –¥—Ä.). –¢–æ–∫–µ–Ω –∂–∏–≤—ë—Ç **10 –º–∏–Ω—É—Ç** (`verification_token_lifetime_seconds`).
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞: `{origin}/{lk_path}?verufy_token={—Ç–æ–∫–µ–Ω}`.
- –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–∏—Å—å–º–æ ¬´–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏¬ª —Å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π.

–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ: **204 No Content** (—Ç–µ–ª–æ –ø—É—Å—Ç–æ–µ).

### 2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî `POST /verify`

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –ø–∏—Å—å–º–∞. –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä —Å —Ç–æ–∫–µ–Ω–æ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:** `{"token": "<—Ç–æ–∫–µ–Ω –∏–∑ —Å—Å—ã–ª–∫–∏>"}`.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `UserManager.verify(token)`.
- –¢–æ–∫–µ–Ω –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `verification_token_secret` –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π audience.
- –ò–∑ payload –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è email –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Ç.—á. `hashed_password`). –ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º –∏–ª–∏ –∏—Å—Ç—ë–∫—à–µ–º —Ç–æ–∫–µ–Ω–µ ‚Äî `400` —Å –∫–æ–¥–æ–º `VERIFY_USER_BAD_TOKEN`.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º email –µ—â—ë –Ω–µ—Ç (–∏–Ω–∞—á–µ ‚Äî –æ—à–∏–±–∫–∞ ¬´–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç¬ª).
- –í –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `is_verified=True`.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –ë–î** —á–µ—Ä–µ–∑ `user_db.create(data)`.
- –í –æ—Ç–≤–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Å—Ö–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

**–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:**

- `VERIFY_USER_BAD_TOKEN` ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π audience.
- `VERIFY_USER_ALREADY_VERIFIED` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ verify –æ–Ω —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `is_verified=True`).

### –°—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞

```
–ö–ª–∏–µ–Ω—Ç                    Auth Service                    Email
   |                             |                            |
   |  POST /register              |                            |
   |  { email, password }         |                            |
   | ---------------------------->|                            |
   |                             |  on_before_register:       |
   |                             |  - JWT —Å –¥–∞–Ω–Ω—ã–º–∏ (10 –º–∏–Ω)  |
   |                             |  - —Å—Å—ã–ª–∫–∞ —Å —Ç–æ–∫–µ–Ω–æ–º        |
   |                             | --------------------------->|  –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π
   |  204 No Content              |                            |
   | <----------------------------|                            |
   |                             |                            |
   |  (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ, —Ñ—Ä–æ–Ω—Ç –±–µ—Ä—ë—Ç token)   |
   |                             |                            |
   |  POST /verify                |                            |
   |  { "token": "..." }          |                            |
   | ---------------------------->|                            |
   |                             |  decode JWT, create user    |
   |  user (201/200 + body)       |                            |
   | <----------------------------|                            |
```

–ò—Ç–æ–≥: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `POST /verify` —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ –ø–∏—Å—å–º–∞; –¥–æ —ç—Ç–æ–≥–æ –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è.


---

# üìò –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ Refresh Token Flow

## üìå –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:

* **JWT access token** (–∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π)
* **Refresh token** (–¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î)
* –û–±–∞ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ **HttpOnly cookies**
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Refresh Token Rotation**

---

# üîê –¢–∏–ø—ã —Ç–æ–∫–µ–Ω–æ–≤

## 1Ô∏è‚É£ Access Token

* –¢–∏–ø: JWT
* –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è API-–∑–∞–ø—Ä–æ—Å–æ–≤
* –°—Ä–æ–∫ –∂–∏–∑–Ω–∏: –∫–æ—Ä–æ—Ç–∫–∏–π (10 –º–∏–Ω—É—Ç)
* –•—Ä–∞–Ω–µ–Ω–∏–µ: HttpOnly cookie
* –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

* –î–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º endpoint'–∞–º
* –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 2Ô∏è‚É£ Refresh Token

* –¢–∏–ø: —Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–µ JWT)
* –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î
* –°–≤—è–∑–∞–Ω —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ `user_id`
* –°—Ä–æ–∫ –∂–∏–∑–Ω–∏: –¥–ª–∏–Ω–Ω—ã–π ( 7 –¥–Ω–µ–π)
* –•—Ä–∞–Ω–∏—Ç—Å—è –≤ HttpOnly cookie
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access token

---

# üç™ Cookie-–ø–æ–ª–∏—Ç–∏–∫–∞

## Access Token Cookie

* `HttpOnly = True`
* `Secure = True` (–≤ production)
* `SameSite = Lax`
* `Path = "/"`

## Refresh Token Cookie

* `HttpOnly = True`
* `Secure = True`
* `SameSite = Strict`
* `Path = /auth/refresh`

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ `Path` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ refresh token –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ endpoint –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.

---

# üîÑ –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üîπ –õ–æ–≥–∏–Ω (`POST /login`)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email –∏ –ø–∞—Ä–æ–ª—å.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:

   * access token (JWT)
   * refresh token (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î)
4. –¢–æ–∫–µ–Ω—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ cookies.
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `204 No Content`.

---

## üîπ –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º endpoint'–∞–º

1. –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç access token cookie.
2. –°–µ—Ä–≤–µ—Ä –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JWT.
3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω ‚Äî –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.
4. –ï—Å–ª–∏ –∏—Å—Ç—ë–∫ ‚Äî –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å `/refresh`.

---

## üîπ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (`POST /refresh`)

### –ê–ª–≥–æ—Ä–∏—Ç–º:

1. –ò–∑ cookies –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è refresh token.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:

   * —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤ –ë–î
   * –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω:

   * —Å—Ç–∞—Ä—ã–π refresh token —É–¥–∞–ª—è–µ—Ç—Å—è (rotation)
   * —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π refresh token
   * –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π access token
4. –û–±–∞ —Ç–æ–∫–µ–Ω–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ cookies.
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `204 No Content`.

---

# üîÅ Refresh Token Rotation

–ö–∞–∂–¥—ã–π refresh token:

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
* –£–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
* –ó–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–æ–≤—ã–º

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç:

* –ö—Ä–∞–∂–∏ —Ç–æ–∫–µ–Ω–∞
* Replay-–∞—Ç–∞–∫
* Reuse-–∞—Ç–∞–∫

---

# üö™ Logout (`POST /logout`)

1. Access cookie –æ—á–∏—â–∞–µ—Ç—Å—è
2. Refresh cookie –æ—á–∏—â–∞–µ—Ç—Å—è
3. Refresh token —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î

–ü–æ—Å–ª–µ logout –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

---

# üóÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã refresh_tokens

| –ü–æ–ª–µ       | –¢–∏–ø      | –û–ø–∏—Å–∞–Ω–∏–µ         |
| ---------- | -------- | ---------------- |
| id         | int      | PK               |
| token      | string   | —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω |
| user_id    | FK       | –≤–ª–∞–¥–µ–ª–µ—Ü         |
| expires_at | datetime | —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è    |
| created_at | datetime | –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è    |

---

# üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

## –ó–∞—â–∏—Ç–∞ –æ—Ç XSS

* –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ HttpOnly cookies
* JavaScript –Ω–µ –∏–º–µ–µ—Ç –∫ –Ω–∏–º –¥–æ—Å—Ç—É–ø–∞

## –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF

* Refresh token –æ–≥—Ä–∞–Ω–∏—á–µ–Ω `Path`
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SameSite=Strict`
* Refresh endpoint ‚Äî —Ç–æ–ª—å–∫–æ POST

## –ó–∞—â–∏—Ç–∞ –æ—Ç reuse

* –¢–æ–∫–µ–Ω —É–¥–∞–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
* –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

---

# üß† –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (Production)

* –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ reuse
* –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö refresh —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* –î–æ–±–∞–≤–∏—Ç—å device_id –¥–ª—è multi-device –ø–æ–¥–¥–µ—Ä–∂–∫–∏
* –î–æ–±–∞–≤–∏—Ç—å "logout from all devices"
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ

---

# üìä –ò—Ç–æ–≥

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è       |
| ---------------- | ---------------- |
| Access token     | JWT              |
| Refresh token    | –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î    |
| Storage          | HttpOnly cookies |
| Rotation         | –î–∞               |
| Reuse protection | –î–∞               |
| Multi-device     | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è   |
| Production-ready | –î–∞               |
